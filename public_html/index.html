<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Cifrado asimetrico</title>
        <link type="text/css" rel="stylesheet" href="recursos/css/bootstrap.css">
        <link type="text/css" rel="stylesheet" href="recursos/css/Ingesoft2.css">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width">
        <style>
            article{
                overflow-x: auto;
            }
            article span{
                display: block;
            }
            table, th, td{
                border: 1px solid white;
                text-align: center;
            }
            article table, article p, article input{
                width: 100%;
                margin-top: 20px;
            }
        </style>
    </head>
    <body>
        <header>
            <button class="izquierda glyphicon glyphicon-align-justify" id="btn-opciones"><span>Menú</span></button>
            <span>Cifrado asimetrico</span>
        </header>

        <article>
            <input id="inpt" type="text" placeholder="Texto a cifrar">
            <div id="spn-txt">
            </div>
            <div id="div-code">
            </div>
        </article>

        <footer>
            <div class="izquierda">
                <input type="checkbox" id="cb">
                <label for="cb">Automatico?</label>
                <input id="delay" type="number" placeholder="3 segundos">
            </div>
            <button id="btn-cifrar" class="derecha glyphicon glyphicon-flash"><span>Cifrar</span></button>
        </footer>

        <aside>
            <ul>
                <li id="li-preferencias"><a href="#"><span class="glyphicon glyphicon-cog"></span> Preferencias</a></li>
                <li id="li-teoria"><a href="#"><span class="glyphicon glyphicon-book"></span> Teoria</a></li>
                <li id="li-acerca"><a href="#"><span class="glyphicon glyphicon-question-sign"></span> Acerca de esta app</a></li>
            </ul>
        </aside>
        <script src="recursos/utiles.js" type="text/javascript"></script>
        <script src="recursos/BigInteger.js" type="text/javascript"></script>
        <script src="recursos/jquery/jquery.js" type="text/javascript"></script>
        <script src="recursos/bootstrap/bootstrap.js" type="text/javascript"></script>
        <script type="text/javascript">
            var Vista = new Object();
            var Control = new Object();

            Control.a = new Array();//input
            Control.r = new Array();//output
            Control.p = 17;//19
            Control.q = 19;//13
            Control.phi = 0;//Calc
            Control.llavec = 11;//1<this<phi & 1=gcd(phi,this)
            Control.llaved = 1;//1<this<phi & cd= 1 mod phi
            Control.mod = 0;//p*q

            Control.delay = 0;
            Control.cifrado = new Array();
            Control.texto = "";
            
            /**
             * Algoritmo extendido de euclides
             * @param {number} a primo
             * @param {number} b primo
             * @returns {Array}
             */
            Math.eea = function(a,b){
                var quot, a1=1, b1=0, a2=0, b2=1, aneg=1, bneg=1, result = new Array;
                if(a < 0) a = -a; aneg=-1;
                if(b < 0) b = -b; bneg=-1;
                if(b > a) {
                    var temp = a;
                    a = b;
                    b = temp;
                }
                while (true) {
                   quot = -Math.floor(a / b);
                   a %= b;
                   a1 += quot*a2; b1 += quot*b2;
                   if(a == 0) {result[0]=b*bneg; result[1]=a2; result[2]=b2; return result;};
                   quot = -Math.floor(b / a);
                   b %= a;
                   a2 += quot*a1; b2 += quot*b1;
                  if(b == 0) {result[0]=a*aneg; result[1]=a1; result[2]=b1; return result;};
                };
                return result;
            }

//Control
            Control.generar = function (){
                Control.mod = Control.p*Control.q;
                Control.phi = (Control.p-1)*(Control.q-1);//253
                //Control.llavec = 3;//1<this<phi & 1=gcd(phi,this)
                {//escoje el menor eea para decrif
                    var temp = Math.eea(Control.llavec,Control.phi);
                    for(var i = 0; i < temp.length;i++)
                        if(temp[i] > 0)
                            if(Control.llaved == 1 | Control.llaved > temp[i]) Control.llaved = temp[i];
                }
            };
            Control.cifrar = function (t){
                Control.texto = t;
                if(!isNaN(parseFloat($("#delay").val()))) Control.delay = $("#delay").val()*1000;
                else Control.delay = 3000;
                Control.cifrado[0] = "";
                for(var i = 0; i < t.length; i++){
                    Control.a[i] = t.charCodeAt(i);
                    var tempo = bigInt(Control.a[i]).pow(Control.llavec);
                    Control.cifrado[i+1] = tempo.mod(Control.mod);
                    Control.cifrado[0] += ""+Control.cifrado[i+1].toString();
                }
                Control.decifrar();
                Vista.generar();

            };
            Control.decifrar = function (){
                
                for(var k = 0; k < Control.cifrado.length; k++){
                    var tempod = bigInt(Control.cifrado[k+1]).pow(Control.llaved);
                    Control.r[k] = tempod.mod(Control.mod);
                }
                console.log("debug");

            };
//Vista            
            Vista.generar = function (){
                $("#div-code").html($("#txt-generar").html().format(Control.p,Control.q));
                var reloj= 1;
                setTimeout(function (){
                    $("ol").append($("#txt-generar-1").html().format(Control.mod));
                }, Control.delay*reloj++);
                setTimeout(function (){
                    $("ol").append($("#txt-generar-2").html().format(Control.phi));
                }, Control.delay*reloj++);
                setTimeout(function (){
                    $("ol").append($("#txt-generar-3").html().format(Control.llavec));
                }, Control.delay*reloj++);
                setTimeout(function (){
                    $("ol").append($("#txt-generar-4").html().format(Control.llaved));
                }, Control.delay*reloj++);
                
                setTimeout(Vista.llenarLetras, Control.delay*reloj++);
                setTimeout(Vista.llenarCharCodes, Control.delay*reloj++);
                setTimeout(Vista.llenarp, Control.delay*reloj++);
                setTimeout(Vista.llenarpmod, Control.delay*reloj++);
                setTimeout(Vista.cifrado, Control.delay*reloj++);
                setTimeout(Vista.llenarCifrado, Control.delay*reloj++);
                setTimeout(Vista.llenarc, Control.delay*reloj++);
                setTimeout(Vista.llenarcmod, Control.delay*reloj++);
                setTimeout(Vista.llenarResultado, Control.delay*reloj++);
            };
            Vista.llenarLetras = function (){
                $("#div-code").append($("#txt-0").html().format("",$("#txt-1").html()));
                $("#div-code").append($("#code-tabla").html().format(Control.llavec,Control.mod));//Limpia la tabla
                var j=0;
                setInterval(function (){
                    if(j < Control.texto.length){
                        $("table").append($("#code-tabla-linea").html().format(Control.texto[j],"","","",""));
                        j++;
                    }
                },300);
            };
            Vista.llenarCharCodes = function (){
                $("ol")[1].innerHTML += $("#txt-2").html();
                var j=0;
                setInterval(function (){
                    if(j < Control.a.length){
                        $("td")[(j*4)+1].innerHTML= Control.a[j];
                        j++;
                    }
                },300);
            };
            Vista.llenarp = function (){
                $("ol")[1].innerHTML += $("#txt-3").html();
                var j=0;
                setInterval(function (){
                    if(j < Control.a.length){
                        var te = bigInt(Control.a[j]).pow(Control.llavec);
                        $("td")[(j*4)+2].innerHTML= te.toString();
                        j++;
                    }
                },300);
            };
            Vista.llenarpmod = function (){
                $("ol")[1].innerHTML += $("#txt-4").html().format(Control.mod);
                var j=0;
                setInterval(function (){
                    if(j < Control.a.length){
                        $("td")[(j*4)+3].innerHTML= Control.cifrado[j+1];
                        j++;
                    }
                },300);
            };
            Vista.cifrado = function (){
                $("#div-code").append($("#code-cifrado").html().format(Control.cifrado[0]));
            };

//Descifrado
            Vista.llenarCifrado = function (){
                var t = Control.cifrado;
                $("#div-code").append(
                    $("#txt-0").html().format("de",$("#txt-5").html().format(Control.mod))
                );
                $("#div-code").append($("#code-tabla2").html().format(Control.llaved,Control.mod));
                var j=1;
                setInterval(function (){
                    if(j < t.length){
                        $("#t2").append($("#code-tabla-linea").html().format(t[j],"","","",""));
                        $('article').animate({
                            scrollTop: $("#t2").offset().top
                        }, 200);
                //});
                        j++;
                    }
                },300);
            };
            Vista.llenarc = function (){
                var t = Control.cifrado;
                $("ol")[2].innerHTML +=
                    $("#txt-6").html().format(Control.llaved);
                var j=1;
                setInterval(function (){
                    var te = bigInt(Control.cifrado[j-1]).pow(Control.llaved);
                    if(j < Control.cifrado.length){
                        $("td")[(j*4)+(Control.a.length*4)-3].innerHTML= te.toString();
                        j++;
                    }
                },300);
            };
            Vista.llenarcmod = function (){
                var t = Control.cifrado;
                $("ol")[2].innerHTML +=
                    $("#txt-7").html().format(Control.mod);
                var j=1;
                setInterval(function (){
                    if(j < Control.cifrado.length){
                        $("td")[(j*4)+(Control.a.length*4)-2].innerHTML= Control.r[j-1];
                        j++;
                    }
                },300);
            };
            Vista.llenarResultado = function (){
                var t = Control.cifrado;
                $("ol")[2].innerHTML +=
                    $("#txt-7").html().format(Control.mod);
                var j=1;
                setInterval(function (){
                    if(j < Control.cifrado.length){
                        $("td")[(j*4)+(Control.a.length*4)-1].innerHTML= 
                            String.fromCharCode(Control.r[j-1]);
                        j++;
                    }
                },300);
            };
            
            
//MAIN
            $("document").ready(function (){
                $("#btn-cifrar").click(function (){
                    Control.generar();
                    var t = $("#inpt").val();
                    if(t == "" ){
                        $("#spn-txt").html($("#txt-err-vacio").html());
                        $("#div-code").html("");
                    } else Control.cifrar(t);
                });
            });
        </script>
        <script type="text/template" id="txt-err-vacio">
            <b>Escribe un texto para cifrar.</b>
        </script>
        <script type="text/template" id="txt-generar">
            <p>Teniendo los primos <math>p={0}, q={1}</math> se generaran las llaves de cifrado y decifrado.<br>
            Para esto tambien es necesario hallár un modulo.
                <ol></ol>
            <p>
        </script><script type="text/template" id="txt-generar-1">
            <li>El modulo lo hallamos simplemente multiplicando los primos: <math>m=pq={0}</math></li>
        </script><script type="text/template" id="txt-generar-2">
            <li>Se define fi(φ) como: <math>φ=(p-1)(q-1)={0}</math></li>
        </script><script type="text/template" id="txt-generar-3">
            <li>Se escoje un primo para la llave de crifrado tal que: <math>1 &lt c &lt φ, c primo relativo a φ; c={0}</math></li>
        </script><script type="text/template" id="txt-generar-4">
            <li>finalmente se calcula la llave de decrifrado tal que: <math>1 &lt d &lt φ, d primo relativo a φ, cd ≡ 1 mod φ; d={0}</math></li>
        </script>
        <script type="text/template" id="txt-0">
            <p><b>Proceso de {0}cifrado</b>
                <ol>{1}</ol>
            </p>
        </script><script type="text/template" id="txt-1">
            <li>Separamos el texto caracter por caracter</li>
        </script><script type="text/template" id="txt-2">
            <li>Pasamos el caracter a cifrar a codigo numerico</li>
        </script><script type="text/template" id="txt-3">
            <li>Elevamos a la 3 cada codigo numerico</li>
        </script><script type="text/template" id="txt-4">
            <li>Finalmente aplicamos el modulo {0}</li>
        </script><script type="text/template" id="txt-5">
            <li>Desglosamos el texto cifrado cada numero menor a {0}</li>
        </script><script type="text/template" id="txt-6">
            <li>Acontinuación elevamos cada numero a la {0}</li>
        </script><script type="text/template" id="txt-7">
            <li>Aplicamos el modulo {0}</li>
        </script>
        <script type="text/template" id="code-cifrado">
            <p>Ahora teniendo el texto cifrado:<br><b>{0}</b><br>
            podemos compartir este texto para posterior descifrado</p>
        </script>
        <script type="text/template" id="code-tabla">
            <table>
                <tr>
                    <th>Letra</th>
                    <th>Codigo numerico</th>
                    <th>p<sup>{0}</sup></th>
                    <th>p<sup>{0}</sup>mod({1})</th>
                </tr>
            </table>
        </script>
        <script type="text/template" id="code-tabla2">
            <table id="t2">
                <tr>
                    <th>Cifrado</th>
                    <th>c<sup>{0}</sup></th>
                    <th>c<sup>{0}</sup>mod({1})</th>
                    <th>Letra resultante</th>
                </tr>
            </table>
        </script>
        <script type="text/template" id="code-tabla-linea">
            <tr>
                <td>{0}</td>
                <td>{1}</td>
                <td>{2}</th>
                <td>{3}</td>
            </tr>
        </script>
    </body>
</html>
